# サーバーレスDB候補サマリー

## STAR: サーバーレス志向のデータ層を選ぶ目的
### Situation
- spot-diggzは個人〜小規模利用を想定し、常時稼働インスタンスの固定費を抑えたい。
- 位置情報・ユーザー情報を扱うため読み書き頻度は波があり、ピーク時のみスケールできる基盤が理想。
### Task
- リクエスト課金や従量制が中心で、最小構成費用が少ないGCPマネージドデータベースを比較検討する。
- 将来的なスケールや学習効果を踏まえ、Rustから扱いやすいSDK/クライアントがあることを確認する。
### Action
- Firestore、Cloud SQL（サーバーレスオプション）、AlloyDB Omni、BigQueryなど候補を整理し、費用モデルとユースケース適性を評価する。
- 選定結果と理由をドキュメント化し、IaCで構築する際の指針とする。
### Result
- 現時点ではFirestore（Nativeモード）が最適なリクエスト課金型データベースであることを確認し、他候補をいつ検討すべきかの目安を得られる。

## 候補比較（費用モデルと特性）
| サービス | 課金モデル | 特徴 | 適性 |
|----------|------------|------|------|
| **Firestore (Native)** | リクエスト/ストレージ従量 | サーバーレス、スキーマレス。SDK豊富。1GB無料枠 + 書込/読込無料枠。 | スポット・ユーザーデータ、通知キュー |
| **Cloud SQL (PostgreSQL/Serverless)** | ベース料金 + クエリ/ストレージ | クエリベース課金のサーバーレスモードあり（2023 GA）。RDB機能が必要なとき。 | リレーション/トランザクション重視時に候補 |
| **AlloyDB Omni** | vCPU/メモリ従量 | 高性能Postgre互換。自管理クラスタ or GKE上で稼働。最低構成費が高め。 | 高負荷分析・BI連携 |
| **BigQuery** | ストレージ + クエリ課金 | DWH用途。書き込み/更新はバッチ寄り。ストリーミング挿入は有料。 | 分析・イベントログ |
| **Memorystore/Redis** | ノード課金（常時稼働） | キャッシュ専用。最小ノード費あり。 | レイテンシ要求/セッション管理 |

## Firestoreを第一候補にする理由
- **従量課金**: 最初の1GB/日5万書込など無料枠が充実し、個人開発での常時費用がほぼ0円から開始できる。
- **サーバーレス**: インスタンス管理不要で、スポット投稿が集中しても自動でスケールする。
- **セキュリティ**: Firestore Security Rulesで認証済みユーザーに対する細かいアクセス制御が可能。RustからはREST/ gRPC経由で呼び出し、Cloud RunサービスアカウントにIAMロールを付与する。

## Cloud SQL/Serverless を検討するタイミング
- **ユースケース**: リレーショナルな結合・トランザクションが不可欠、または既存SQLクエリ資産を活用したい場合。
- **費用**: ベース料金が発生するため、Firestoreよりも固定費が高い。ピーク性能や複雑なJOINが必須のときに導入検討。
- **アーキテクチャ**: Serverless接続は自動プロビジョニングだが、RustからはPostgreSQLドライバ（`tokio-postgres`など）とCloud SQL Auth ProxyやIAM DB認証を組み合わせる必要がある。

## BigQueryを利用する位置付け
- **用途**: 行単位更新よりも、集計や分析レポート向け。スポットのアクセスログや利用頻度分析、監査ログの二次利用に適する。
- **連携**: Cloud Runから`google-cloud-bigquery`クライアントでデータロード。定期バッチやPub/Sub→Dataflow経由のパイプラインが一般的。
- **費用**: ストレージ0.02USD/GB、クエリ0.005USD/GBスキャン（オンデマンド）。大量データのときに活用する。

## 今後のアクション
- 開発初期はFirestore（Nativeモード）を基盤とし、ユーザー/スポット/投稿メタデータを格納するスキーマを詳細設計する。
- IaC（Terraform）で`google_firestore_database`リソースを定義し、開発・ステージング・本番環境を分離。
- Cloud SQLやBigQueryを追加する際は、このメモを基に要件整理を再度STAR形式で行う。
