# 〔ヒアリング〕Tier 2 スポット登録機能 — データアーキテクチャ設計

📅 日時: 2026-02-28
👤 担当: 白鐘直斗（設計・要件定義）
👤 起票者: ユーザー

---

## 結論

スポットデータを `Tier 1`（マスターデータ）と `Tier 2`（ユーザー個人データ）に分離し、`Tier 2` はiOS端末のSwiftData + CloudKit（オプション）でローカル管理する。Firestoreはマスターデータ専用の読み取り配信ストアとして維持する。Rust APIは読み取り中心のサービスに役割を縮小する。

---

## 要件整理

### ゴール

ユーザーが個人的なスケートスポットを地図上にプロットして保存できるサブ機能を追加する。サービス提供者のクラウドリソースを圧迫せず、ユーザーのプライバシーを担保する。

### 機能要件

- [ ] `Tier 2` スポットのCRUD（作成・読取・更新・削除）をSwiftDataで実装
- [ ] `Tier 2` スポットへの画像添付（ローカル保存、`@Attribute(.externalStorage)` 使用）
- [ ] iCloudオン時のCloudKit同期（端末間引き継ぎ・アンインストール後の復元）
- [ ] iCloudオフ時の注意表示（「iCloudを有効にするとバックアップできます」）
- [ ] アカウント削除時に `Tier 2` データ（ローカル + CloudKit）を完全削除
- [ ] 地図上で `Tier 1` / `Tier 2` スポットを混在表示（ピンの視覚的区別あり）
- [ ] マイリスト（お気に入り）機能の維持（ストレージはSwiftData + CloudKitに移行）
- [ ] マスターデータ投入はバッチスクリプトでFirestoreに直接書き込み（API経由ではない）

### 非機能要件

- パフォーマンス: `Tier 2` データはローカル読み取りのため遅延なし。`Tier 1` はAPI経由で取得
- コスト: `Tier 2` のクラウドリソース消費ゼロ（iCloudストレージはユーザー負担）。Firestoreは無料枠内で運用
- セキュリティ: `Tier 2` データはサービス提供者から不可視。Firestoreへのユーザー書き込み経路なし
- App Store準拠: ガイドライン 5.1.1(v) アカウント削除要件を満たす。Apple推奨技術スタック使用

### 技術的制約・前提

- iOS: Xcode 26 / Swift 6 / SwiftData + CloudKit
- 認証: Google Sign-In / Apple ID（Firebase Auth / Identity Platform経由）
- バックエンド: Rust API は読み取り専用に近い役割（書き込みエンドポイントは休眠）
- データベース: Firestore は `Tier 1` マスターデータ専用
- データ投入: バッチスクリプト → Firestore直接書き込み（管理者のみ）

### アーキテクチャ概要

```
〔データ加工層〕
  管理者 → CSV/スプレッドシート/BigQuery → バッチスクリプト → Firestore

〔配信層〕
  Firestore → Rust API → iOS（Tier 1 読み取り）

〔ユーザーデータ層〕
  iOS SwiftData ←→ CloudKit/iCloud（Tier 2、オプション同期）
```

### API エンドポイントの役割変更

| エンドポイント | メソッド | 新設計での役割 |
|:--|:--|:--|
| `/sdz/health` | GET | 変更なし |
| `/sdz/users/me` | GET | 変更なし（認証・プロファイル取得） |
| `/sdz/spots` | GET | `Tier 1` マスターデータ一覧配信 |
| `/sdz/spots/{id}` | GET | `Tier 1` スポット詳細配信 |
| `/sdz/spots` | POST | 休眠（将来の Tier 昇格で再利用の可能性） |
| `/sdz/spots/{id}` | PATCH | 休眠 |
| `/sdz/spots/upload-url` | POST | 休眠（`Tier 2` 画像はローカル保存） |
| `/sdz/mylists/*` | ALL | SwiftData + CloudKit に移行後、休眠 |

### スコープ外（今回やらないこと）

- `Tier 2` → `Tier 1` 昇格機能（将来の拡張ポイントとして残す）
- Firestoreへのユーザー書き込み経路
- 管理者用Web UI
- API書き込みエンドポイントの改修（休眠させるだけで削除はしない）

### 将来の拡張ポイント

- `Tier 2` → `Tier 1` 昇格: 承認ワークフローの追加。この時点でFirestoreへの書き込み経路を開放する
- BigQueryを使ったマスターデータETLパイプライン
- API書き込みエンドポイントの管理者限定化（ロールベースアクセス制御）

---

## ヒアリングログ

1. ユーザーからスポットデータのティア分け（Tier 1 / Tier 2）とローカルストレージ保存の要望を受領
2. 現行コードベースを調査。承認/未承認ステータス・ティアシステム・ローカルストレージ（CoreData/SwiftData）は未実装であることを確認
3. データ永続性・ストレージ技術・画像・地図表示の4点を確認
4. ユーザーから「アプリ削除ではデータを残し、アカウント削除時のみ削除」の要件を受領
5. iOSサンドボックスの制約を説明。SwiftData + CloudKitの方式を提案
6. Firestoreの役割縮小について議論。BigQuery代替案を検討したが、配信DBとしてのレイテンシ問題を指摘
7. 2層アーキテクチャ（データ加工層 + 配信層）で合意
8. マイリストについて玉縄の設計書を確認。明示的な削除判断なし。維持の方向で整理
9. 玉縄の設計書に既存のTier定義があり、今回の方針と整合していることを確認

---

## 未決事項（UXレビュー待ち）

- [ ] `Tier 1` / `Tier 2` ピンの視覚的区別方法（色・形状・アイコン）→ 玉縄に相談
- [ ] マイリストのSwiftData移行に伴うUI変更の有無 → 玉縄に相談
